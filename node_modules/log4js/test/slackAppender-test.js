"use strict";function setupLogging(e,s){var o=[],t={token:s.token,channel_id:s.channel_id,username:s.username,format:s.format,icon_url:s.icon_url},a=function(e){function s(){return{options:e,api:function(e,s,t){o.push(s),t(!1,{status:"sent"})}}}return s(e)},n={layout:function(e,s){return this.type=e,this.config=s,log4js.layouts.messagePassThroughLayout},basicLayout:log4js.layouts.basicLayout,coloredLayout:log4js.layouts.coloredLayout,messagePassThroughLayout:log4js.layouts.messagePassThroughLayout},r={errors:[],logs:[],error:function(e,s){this.errors.push({msg:e,value:s})},log:function(e,s){this.logs.push({msg:e,value:s})}},u=sandbox.require("../lib/appenders/slack",{requires:{"slack-node":a,"../layouts":n},globals:{console:r}});return log4js.addAppender(u.configure(s),e),{logger:log4js.getLogger(e),mailer:a,layouts:n,console:r,messages:o,credentials:t}}function checkMessages(e){for(var s=0;s<e.messages.length;++s)assert.equal(e.messages[s].channel,"#CHANNEL"),assert.equal(e.messages[s].username,"USERNAME"),assert.ok(new RegExp(".+Log event #"+(s+1)).test(e.messages[s].text))}var vows=require("vows"),assert=require("assert"),log4js=require("../lib/log4js"),sandbox=require("sandboxed-module");log4js.clearAppenders(),vows.describe("log4js slackAppender").addBatch({"slack setup":{topic:setupLogging("slack setup",{token:"TOKEN",channel_id:"#CHANNEL",username:"USERNAME",format:"FORMAT",icon_url:"ICON_URL"}),"slack credentials should match":function(e){assert.equal(e.credentials.token,"TOKEN"),assert.equal(e.credentials.channel_id,"#CHANNEL"),assert.equal(e.credentials.username,"USERNAME"),assert.equal(e.credentials.format,"FORMAT"),assert.equal(e.credentials.icon_url,"ICON_URL")}},"basic usage":{topic:function(){var e=setupLogging("basic usage",{token:"TOKEN",channel_id:"#CHANNEL",username:"USERNAME",format:"FORMAT",icon_url:"ICON_URL"});return e.logger.info("Log event #1"),e},"there should be one message only":function(e){assert.equal(e.messages.length,1)},"message should contain proper data":function(e){checkMessages(e)}},"config with layout":{topic:function(){var e=setupLogging("config with layout",{layout:{type:"tester"}});return e},"should configure layout":function(e){assert.equal(e.layouts.type,"tester")}},"separate notification for each event":{topic:function(){var e=this,s=setupLogging("separate notification for each event",{token:"TOKEN",channel_id:"#CHANNEL",username:"USERNAME",format:"FORMAT",icon_url:"ICON_URL"});setTimeout(function(){s.logger.info("Log event #1")},0),setTimeout(function(){s.logger.info("Log event #2")},500),setTimeout(function(){s.logger.info("Log event #3")},1100),setTimeout(function(){e.callback(null,s)},3e3)},"there should be three messages":function(e){assert.equal(e.messages.length,3)},"messages should contain proper data":function(e){checkMessages(e)}}})["export"](module);