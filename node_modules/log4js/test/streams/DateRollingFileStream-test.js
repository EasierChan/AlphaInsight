"use strict";function cleanUp(e){return function(){fs.unlink(e)}}function now(){return testTime.getTime()}var vows=require("vows"),assert=require("assert"),fs=require("fs"),semver=require("semver"),streams,DateRollingFileStream,testTime=new Date(2012,8,12,10,37,11);streams=semver.satisfies(process.version,">=0.10.0")?require("stream"):require("readable-stream"),DateRollingFileStream=require("../../lib/streams").DateRollingFileStream,vows.describe("DateRollingFileStream").addBatch({arguments:{topic:new DateRollingFileStream(__dirname+"/test-date-rolling-file-stream-1","yyyy-mm-dd.hh"),teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-1"),"should take a filename and a pattern and return a WritableStream":function(e){assert.equal(e.filename,__dirname+"/test-date-rolling-file-stream-1"),assert.equal(e.pattern,"yyyy-mm-dd.hh"),assert.instanceOf(e,streams.Writable)},"with default settings for the underlying stream":function(e){assert.equal(e.theStream.mode,420),assert.equal(e.theStream.flags,"a")}},"default arguments":{topic:new DateRollingFileStream(__dirname+"/test-date-rolling-file-stream-2"),teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-2"),"pattern should be .yyyy-MM-dd":function(e){assert.equal(e.pattern,".yyyy-MM-dd")}},"with stream arguments":{topic:new DateRollingFileStream(__dirname+"/test-date-rolling-file-stream-3","yyyy-MM-dd",{mode:parseInt("0666",8)}),teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-3"),"should pass them to the underlying stream":function(e){assert.equal(e.theStream.mode,parseInt("0666",8))}},"with stream arguments but no pattern":{topic:new DateRollingFileStream(__dirname+"/test-date-rolling-file-stream-4",{mode:parseInt("0666",8)}),teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-4"),"should pass them to the underlying stream":function(e){assert.equal(e.theStream.mode,parseInt("0666",8))},"should use default pattern":function(e){assert.equal(e.pattern,".yyyy-MM-dd")}},"with a pattern of .yyyy-MM-dd":{topic:function(){var e=this,t=new DateRollingFileStream(__dirname+"/test-date-rolling-file-stream-5",".yyyy-MM-dd",null,now);t.write("First message\n","utf8",function(){e.callback(null,t)})},teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-5"),"should create a file with the base name":{topic:function(e){fs.readFile(__dirname+"/test-date-rolling-file-stream-5",this.callback)},"file should contain first message":function(e){assert.equal(e.toString(),"First message\n")}},"when the day changes":{topic:function(e){testTime=new Date(2012,8,13,0,10,12),e.write("Second message\n","utf8",this.callback)},teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-5.2012-09-12"),"the number of files":{topic:function(){fs.readdir(__dirname,this.callback)},"should be two":function(e){assert.equal(e.filter(function(e){return e.indexOf("test-date-rolling-file-stream-5")>-1}).length,2)}},"the file without a date":{topic:function(){fs.readFile(__dirname+"/test-date-rolling-file-stream-5",this.callback)},"should contain the second message":function(e){assert.equal(e.toString(),"Second message\n")}},"the file with the date":{topic:function(){fs.readFile(__dirname+"/test-date-rolling-file-stream-5.2012-09-12",this.callback)},"should contain the first message":function(e){assert.equal(e.toString(),"First message\n")}}}},"with alwaysIncludePattern":{topic:function(){var e=this,t=(new Date(2012,8,12,0,10,12),new DateRollingFileStream(__dirname+"/test-date-rolling-file-stream-pattern",".yyyy-MM-dd",{alwaysIncludePattern:!0},now));t.write("First message\n","utf8",function(){e.callback(null,t)})},teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-pattern.2012-09-12"),"should create a file with the pattern set":{topic:function(e){fs.readFile(__dirname+"/test-date-rolling-file-stream-pattern.2012-09-12",this.callback)},"file should contain first message":function(e){assert.equal(e.toString(),"First message\n")}},"when the day changes":{topic:function(e){testTime=new Date(2012,8,13,0,10,12),e.write("Second message\n","utf8",this.callback)},teardown:cleanUp(__dirname+"/test-date-rolling-file-stream-pattern.2012-09-13"),"the number of files":{topic:function(){fs.readdir(__dirname,this.callback)},"should be two":function(e){assert.equal(e.filter(function(e){return e.indexOf("test-date-rolling-file-stream-pattern")>-1}).length,2)}},"the file with the later date":{topic:function(){fs.readFile(__dirname+"/test-date-rolling-file-stream-pattern.2012-09-13",this.callback)},"should contain the second message":function(e){assert.equal(e.toString(),"Second message\n")}},"the file with the date":{topic:function(){fs.readFile(__dirname+"/test-date-rolling-file-stream-pattern.2012-09-12",this.callback)},"should contain the first message":function(e){assert.equal(e.toString(),"First message\n")}}}}}).exportTo(module);