"use strict";function logServer(e){function r(e,r){var t;try{t=JSON.parse(r),t.startTime=new Date(t.startTime),t.level=log4js.levels.toLevel(t.level.levelStr)}catch(n){t={startTime:new Date,categoryName:"log4js",level:log4js.levels.ERROR,data:["Unable to parse log:",r]}}return t.remoteAddress=e.remoteAddress,t.remotePort=e.remotePort,t}var t=e.actualAppender,n=net.createServer(function(e){function n(n){a.length>0&&t(r(e,n))}function o(e){var r;a+=e||"",a.indexOf(END_MSG)>-1&&(r=a.substring(0,a.indexOf(END_MSG)),n(r),a=a.substring(r.length+END_MSG.length)||"",o())}e.setEncoding("utf8");var a="";e.on("data",o),e.on("end",o)});return n.listen(e.loggerPort||5e3,e.loggerHost||"localhost"),t}function workerAppender(e){function r(){o=net.createConnection(e.loggerPort||5e3,e.loggerHost||"localhost"),o.on("connect",function(){t(),a=!0}),o.on("timeout",o.end.bind(o)),o.on("close",r)}function t(){for(var e;e=s.shift();)n(e)}function n(e){e&&e.stack&&"{}"===JSON.stringify(e)&&(e={stack:e.stack}),o.write(JSON.stringify(e),"utf8"),o.write(END_MSG,"utf8")}var o,a=!1,s=[];return r(),function(e){a?n(e):s.push(e)}}function createAppender(e){return"master"===e.mode?logServer(e):workerAppender(e)}function configure(e,r){var t;return e.appender&&"master"===e.mode&&(log4js.loadAppender(e.appender.type),t=log4js.appenderMakers[e.appender.type](e.appender,r),e.actualAppender=t),createAppender(e)}var log4js=require("../log4js"),net=require("net"),END_MSG="__LOG4JS__";exports.appender=createAppender,exports.configure=configure;