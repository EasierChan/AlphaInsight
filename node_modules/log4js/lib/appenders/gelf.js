"use strict";function gelfAppender(e,l,t,n,r){function i(e,l){Object.keys(c).forEach(function(e){e.match(/^_/)&&"_id"!==e&&(l[e]=c[e])});var t=e.data;if(Array.isArray(t)&&0!==t.length){var n=t[0];n.GELF&&(delete n.GELF,Object.keys(n).forEach(function(e){(e.match(/^_/)||"_id"!==e)&&(l[e]=n[e])}),e.data.shift())}}function a(l){var t={};return i(l,t),t.short_message=e(l),t.version="1.1",t.timestamp=t.timestamp||(new Date).getTime()/1e3,t.host=n,t.level=levelMapping[l.level||levels.DEBUG],t}function o(e){client.send(e,0,e.length,t,l,function(e){e&&console.error(e)})}var s,u;"object"==typeof l&&(s=l,l=s.host,t=s.port,n=s.hostname,r=s.facility,u=s.customFields),l=l||"localhost",t=t||12201,n=n||require("os").hostname(),e=e||layouts.messagePassThroughLayout;var c=u||{};return r&&(c._facility=r),client=dgram.createSocket("udp4"),process.on("exit",function(){client&&client.close()}),function(e){var l=a(e);zlib.gzip(new Buffer(JSON.stringify(l)),function(e,l){e?console.error(e.stack):l.length>8192?debug("Message packet length ("+l.length+") is larger than 8k. Not sending"):o(l)})}}function configure(e){var l;return e.layout&&(l=layouts.layout(e.layout.type,e.layout)),gelfAppender(l,e)}function shutdown(e){client&&(client.close(e),client=null)}var zlib=require("zlib"),layouts=require("../layouts"),levels=require("../levels"),dgram=require("dgram"),util=require("util"),debug=require("../debug")("GELF Appender"),LOG_EMERG=0,LOG_ALERT=1,LOG_CRIT=2,LOG_ERR=3,LOG_ERROR=3,LOG_WARNING=4,LOG_NOTICE=5,LOG_INFO=6,LOG_DEBUG=7,levelMapping={};levelMapping[levels.ALL]=LOG_DEBUG,levelMapping[levels.TRACE]=LOG_DEBUG,levelMapping[levels.DEBUG]=LOG_DEBUG,levelMapping[levels.INFO]=LOG_INFO,levelMapping[levels.WARN]=LOG_WARNING,levelMapping[levels.ERROR]=LOG_ERR,levelMapping[levels.FATAL]=LOG_CRIT;var client;exports.appender=gelfAppender,exports.configure=configure,exports.shutdown=shutdown;