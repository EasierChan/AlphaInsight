"use strict";function RollingFileStream(e,i,t,n){function r(){if(!e||!i||0>=i)throw new Error("You must specify a filename and file size")}this.size=i,this.backups=t||1,r(),RollingFileStream.super_.call(this,e,n)}var BaseRollingFileStream=require("./BaseRollingFileStream"),debug=require("../debug")("RollingFileStream"),util=require("util"),path=require("path"),child_process=require("child_process"),zlib=require("zlib"),fs=require("fs");module.exports=RollingFileStream,util.inherits(RollingFileStream,BaseRollingFileStream),RollingFileStream.prototype.shouldRoll=function(){return debug("should roll with current size "+this.currentSize+" and max size "+this.size),this.currentSize>=this.size},RollingFileStream.prototype.roll=function(e,i){function t(e){return u.test(e)}function n(i){return debug("Calculating index of "+i),parseInt(i.substring((path.basename(e)+".").length),10)||0}function r(e,i){return n(e)>n(i)?1:n(e)<n(i)?-1:0}function l(e,i){var t=zlib.createGzip(),n=fs.createReadStream(e),r=fs.createWriteStream(e+".gz");n.pipe(t).pipe(r),fs.unlink(e,i)}function s(i,t){var r=n(i);if(debug("Index of "+i+" is "+r),r<o.backups){var s=path.extname(i),a=e+"."+(r+1);o.options.compress&&/^gz$/.test(s.substring(1))&&(a+=s),fs.unlink(a,function(n){debug("Renaming "+i+" -> "+a),fs.rename(path.join(path.dirname(e),i),a,function(e){e?t(e):o.options.compress&&".gz"!=s?l(a,t):t()})})}else t()}function a(i){debug("Renaming the old files"),fs.readdir(path.dirname(e),function(e,n){var l=n.filter(t).sort(r);!function a(e){var t=l.pop();return!t||e?i(e):void s(t,a)}()})}var o=this,u=new RegExp("^"+path.basename(e));debug("Rolling, rolling, rolling"),this.closeTheStream(a.bind(null,this.openTheStream.bind(this,i)))};