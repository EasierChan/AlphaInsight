"use strict";function getLogger(e,t){t="object"==typeof t?t||{}:t?{format:t}:{};var r=e,n=levels.toLevel(t.level,levels.INFO),o=t.format||DEFAULT_FORMAT,s=t.nolog?createNoLogCondition(t.nolog):null;return function(e,a,l){if(e._logging)return l();if(s&&s.test(e.originalUrl))return l();if(r.isLevelEnabled(n)||"auto"===t.level){var u,i=new Date,c=a.writeHead;e.originalUrl;e._logging=!0,a.writeHead=function(e,r){a.writeHead=c,a.writeHead(e,r),a.__statusCode=u=e,a.__headers=r||{},"auto"===t.level?(n=levels.INFO,e>=300&&(n=levels.WARN),e>=400&&(n=levels.ERROR)):n=levels.toLevel(t.level,levels.INFO)},a.on("finish",function(){if(a.responseTime=new Date-i,a.statusCode&&"auto"===t.level&&(n=levels.INFO,a.statusCode>=300&&(n=levels.WARN),a.statusCode>=400&&(n=levels.ERROR)),r.isLevelEnabled(n)){var s=assemble_tokens(e,a,t.tokens||[]);if("function"==typeof o){var l=o(e,a,function(e){return format(e,s)});l&&r.log(n,l)}else r.log(n,format(o,s))}})}l()}}function assemble_tokens(e,t,r){var n=function(e){for(var t=e.concat(),r=0;r<t.length;++r)for(var n=r+1;n<t.length;++n)t[r].token==t[n].token&&t.splice(n--,1);return t},o=[];return o.push({token:":url",replacement:getUrl(e)}),o.push({token:":protocol",replacement:e.protocol}),o.push({token:":hostname",replacement:e.hostname}),o.push({token:":method",replacement:e.method}),o.push({token:":status",replacement:t.__statusCode||t.statusCode}),o.push({token:":response-time",replacement:t.responseTime}),o.push({token:":date",replacement:(new Date).toUTCString()}),o.push({token:":referrer",replacement:e.headers.referer||e.headers.referrer||""}),o.push({token:":http-version",replacement:e.httpVersionMajor+"."+e.httpVersionMinor}),o.push({token:":remote-addr",replacement:e.headers["x-forwarded-for"]||e.ip||e._remoteAddress||e.socket&&(e.socket.remoteAddress||e.socket.socket&&e.socket.socket.remoteAddress)}),o.push({token:":user-agent",replacement:e.headers["user-agent"]}),o.push({token:":content-length",replacement:t._headers&&t._headers["content-length"]||t.__headers&&t.__headers["Content-Length"]||"-"}),o.push({token:/:req\[([^\]]+)\]/g,replacement:function(t,r){return e.headers[r.toLowerCase()]}}),o.push({token:/:res\[([^\]]+)\]/g,replacement:function(e,r){return t._headers?t._headers[r.toLowerCase()]||t.__headers[r]:t.__headers&&t.__headers[r]}}),n(r.concat(o))}function getUrl(e){return e.originalUrl||e.url}function format(e,t){for(var r=0;r<t.length;r++)e=e.replace(t[r].token,t[r].replacement);return e}function createNoLogCondition(e){var t=null;if(e&&(e instanceof RegExp&&(t=e),"string"==typeof e&&(t=new RegExp(e)),Array.isArray(e))){var r=e.map(function(e){return e.source?e.source:e});t=new RegExp(r.join("|"))}return t}var levels=require("./levels"),DEFAULT_FORMAT=':remote-addr - - ":method :url HTTP/:http-version" :status :content-length ":referrer" ":user-agent"';exports.connectLogger=getLogger;